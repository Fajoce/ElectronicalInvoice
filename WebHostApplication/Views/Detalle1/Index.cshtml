@model List<WebHostApplication.ViewModels.Utilidad.UtilidadFacturasDTO>
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-primary shadow">
            <div class="card-body">
                <h5 class="card-title">Total Subtotal</h5>
                <p class="card-text h4">@ViewBag.TotalSubtotal.ToString("C")</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-danger shadow">
            <div class="card-body">
                <h5 class="card-title">Total Costo</h5>
                <p class="card-text h4">@ViewBag.TotalCosto.ToString("C")</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success shadow">
            <div class="card-body">
                <h5 class="card-title">Total Utilidad</h5>
                <p class="card-text h4">@ViewBag.TotalUtilidad.ToString("C")</p>
            </div>
        </div>
    </div>
</div>
<table id="facturasTable" class="table table-striped">
    <thead>
        <tr>
            <th>Factura</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Subtotal</th>
            <th>Costo</th>
            <th>Utilidad</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.NumeroFactura</td>
                <td>@item.Fecha.ToShortDateString()</td>
                <td>@item.ClienteCompleto</td>
                <td>@item.TotalSubtotal.ToString("C")</td>
                <td>@item.TotalCosto.ToString("C")</td>
                <td>@item.TotalUtilidad.ToString("C")</td>
            </tr>
        }
    </tbody>
</table>
<!-- --- DataTables CSS/JS (si NO los tienes en _Layout) --->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- --- Inicialización y chequeos de depuración --->
<script>
    (function ($) {
        $(function () {
            // Chequeo rápido en consola para ver si jQuery/DataTables están presentes
            console.log('jQuery cargado:', typeof jQuery !== 'undefined');
            console.log('DataTables plugin presente:', !!$.fn.DataTable);

            if (typeof jQuery === 'undefined') {
                console.error('jQuery no está definido. Asegúrate de incluir jQuery antes de DataTables.');
                return;
            }
            if (!$.fn.DataTable) {
                console.error('DataTables no está cargado. Comprueba que la URL del script sea accesible.');
                return;
            }

            // Inicializamos DataTable (paginación 25)
            $('#facturasTable').DataTable({
                pageLength: 25,
                lengthMenu: [[25, 50, 100], [25, 50, 100]],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                },
                // Opcional: evita que DataTables intente ordenar columnas con formato moneda incorrectamente
                columnDefs: [
                    { targets: [3,4,5], orderDataType: 'dom-text-numeric' }
                ]
            });
        });
    })(jQuery);
</script>

<!-- --- Plugin pequeño para ordenar números dentro de celdas con símbolos (moneda) --->
<script>
    /* Si los números están con formato "C" (p. ej. $1,234.56), DataTables a veces no los ordena bien.
       Este pequeño 'plugin' extrae sólo los dígitos para ordenar correctamente. */
    (function () {
        if (!jQuery || !jQuery.fn || !jQuery.fn.dataTable) return;

        jQuery.fn.dataTable.ext.order['dom-text-numeric'] = function (settings, col) {
            return this.api().column(col, {order: 'index'}).nodes().map(function (td, i) {
                var txt = jQuery(td).text().replace(/[^\d\-,.\s]/g, '').replace(',', '.');
                return parseFloat(txt) || 0;
            });
        };
    })();
</script>